<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Javascript Hangman (Beta)</title>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-19082249-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
  })();
</script>

<style type="text/css">
body {
	font-family:Arial, Helvetica, sans-serif;
}
form { 
	/*width:450px;*/
	clear:both;
}
fieldset {
	border:#900 solid 2px;
	background-color:#f2f2e6;
	margin-top:.5em;
}
legend {
	color: #000;
	font-style:italic;
	font-weight:bold;
}

#message {
	height:20px;
}

#game,
#credits {
	width:479px
}

#game { 
	margin:0 auto
}

#credits {
	border-top:1px solid #ccc;
	clear:both;
	margin:1em auto;
	color:#999;
}

#gallows,
#guessedLetters {
	height:200px;
}

#gallows { 
	float:left;
	border:dashed 2px #900;
	background-color:#f2f2e6;
	width: 160px;
	padding:10px;
}

#gallows img { 
	width:150px 
}

#guessedLetters { 
	float:left;
	border:dashed 2px #900;
	border-left:none;
	background-color:#f2f2e6;
	width: 270px;
	padding:10px;
	font-size:200%;
}

#word {
	padding: 0 10px 10px 10px;
	text-align:center;
	line-height:2.5em;
}

#word input {
	width:1em;
	text-align:center;
	font-size:large;
	font-weight:bold;
	border:1px solid #CCC;
	border-bottom:2px solid black;
}
.letter,
.letterExists,
.letterDoesNotExist {
	font-weight:bold;
	color:#000;
	background-color:#fafaee;
	border:1px solid #eaeade;
	text-decoration:none;
	display:block;
	float:left;
	width:1.05em;
	text-align:center;
}

.letterExists {
	color: green;
}
.letterDoesNotExist {
	color: #900;
	text-decoration:line-through;
}
</style>
<script type="text/javascript" src="js/ajax.js"></script>
<script type="text/javascript">
var puzzles = [
        {"category": "phrase", "word": "a penny saved is a penny earned"},
        {"category": "place", "word": "johannesburg, south africa"},
        {"category": "person", "word": "marcel marceau"},
		  {"category": "person", "word": "karl marx"},
		  {"category": "book", "word": "The Scarlet Letter"},
		  {"category": "tv show", "word": "Eight is Enough"},
		  {"category": "movie", "word": "Ferris Bueller's Day Off"},
		  {"category": "movie", "word": "Wayne's World"},
		  {"category": "book", "word": "The Great Gatsby"},
		  {"category": "phrase", "word": "Neither a borrower, nor a lender be"},
		  {"category": "person", "word": "keira knightley"},
		  {"category": "place", "word": "Chattanooga, Tennessee"},
		  {"category": "place", "word": "Milwaukee, Wisconsin"},
		  {"category": "place", "word": "Tapei, Taiwan"},
		  {"category": "person", "word": "Lionel Richie"},
		  {"category": "person", "word": "Richard Nixon"},
		  {"category": "movie", "word": "Spartacus"},
		  {"category": "movie", "word": "The Big Chill"},
		  {"category": "tv show", "word": "Miami Vice"},
		  {"category": "book", "word": "harry potter and the half blood prince"}
    ];


var punc = ",.?!' ";
var linelength = 16;
var isGameOver;


function Word(c,w) {
	this.category = c;
	w = w.toUpperCase();
	this.word = w;
	this.letters = w.split("");
}

function Word_getBreakpoint(n) {
	var breakpoint;

	if (this.letters.length-n>linelength) {
		for (var i=n; i<this.letters.length && i<n+linelength; i++) {
			if (this.letters[i]==" ") {
				breakpoint=i;
			}
		}
	}

	return breakpoint;
}


function Word_build() {
	var punc = ",.?!' ";
	var breakpoint = 0;
	var j=0;
	// set current category
	set("category").innerHTML=this.category;
	// clear current word
	set("word").innerHTML='';
	
	if (this.word.length > linelength) {
		breakpoint = this.getBreakpoint(0);
	}
	
	for (var i in this.letters) {
		var regex = new RegExp(this.letters[i]);

		if ( punc.search(regex) < 0 ) {
			set("word").innerHTML += '<input type="text" size="1" maxlength="1" id="w'+i+'">&nbsp;';
		} else {
			set("word").innerHTML += this.letters[i] + '&nbsp;';
		}
		
		if ( i == breakpoint && breakpoint != 0 ) {
			// Add break
			set("word").innerHTML += "<br>";
			// Set new breakpoint
			breakpoint = this.getBreakpoint(breakpoint);
		}
	}
}

function Word_disable() {
	for (var i in this.letters) {
		if (set("w"+i)) {
			set("w"+i).value=this.letters[i];
			set("w"+i).disabled=true;
		}
	}
}


Word.prototype.build = Word_build;
Word.prototype.disable = Word_disable;
Word.prototype.getBreakpoint = Word_getBreakpoint;


function Gallows() {
	this.failures;
}

function Gallows_display() {
	set("gallows").innerHTML = '<img src="' + this.failures + '.png" width="200" height="150" alt="' + (6-this.failures) + 'Chances Left!">';
}

function Gallows_get() {
	return this.failures;
}

function Gallows_set(n) {
	this.failures = n;
}

function Gallows_message(ltr) {
	var msg;
	switch (this.failures) {
		case 5:
			msg="DANGER--Guess carefully!";
			break;
		case 4:
			msg="Uh-oh, things aren't looking good....";
			break;
		default:
			msg="Ouch! There are no " + ltr + "'s!";
			break;
	}
	return msg;
}

Gallows.prototype.display = Gallows_display;
Gallows.prototype.get = Gallows_get;
Gallows.prototype.set = Gallows_set;
Gallows.prototype.message = Gallows_message;

function Letter(l) {
	this.value = l;
	this.guessed = false;
}

function Letter_getValue() {
	return this.value;
}

function Letter_setValue(v) {
	this.value = v;
}

function Letter_getGuessed() {
	return this.guessed;
}

function Letter_setGuessed(b) {
	this.guessed = b;
}

Letter.prototype.getValue = Letter_getValue;
Letter.prototype.setValue = Letter_setValue;
Letter.prototype.getGuessed = Letter_getGuessed;
Letter.prototype.setGuessed = Letter_setGuessed;

// Construct the set of characters that the user can guess (the alphabet)
// Each character is an object of type Letter
function Alphabet() {
	this.abc = "abcdefghijklmnopqrstuvwxyz".toUpperCase();
	for (var i=0; i<this.abc.length; i++) {
		this[this.abc.charAt(i)] = new Letter(this.abc.charAt(i));
	}
}

function Guess(g) {
	this.letter = g.toUpperCase();
}


function buildWord() {
for (var i in letters) {
	set("word").innerHTML += '<input type="text" size="1" id="w'+i+'"> ';
}	
}


function Game() {
	// Game status
	this.isOver;
	
	// Initialize alphabet guessing board
	this.alpha;
	
	// Initialize player feedback "gallows"
	this.noose = new Gallows;
	
	// Initialize puzzle (game phrase to be guessed)
	this.puzzle;
}

// Initialize game
function Game_init() {
	this.isOver = false;

	this.puzzle = this.getPuzzle();
	this.puzzle.build();
	
	// Initialize alphabet guessing board
	this.alpha = new Alphabet;
	
	// Reset feedback board ("gallows")
	this.noose.set(0);
	this.noose.display();

	show("guess");
	show("solve");

	display("message","");

	set("guessedLetters").innerHTML = "";
	for (var i=0; i<this.alpha.abc.length; i++) {
		set("guessedLetters").innerHTML += '<a href="#" id="' + this.alpha.abc.charAt(i) + '" class="letter" onClick="dgame.checkGuess(\'' + this.alpha.abc.charAt(i) + '\'); return false;">' + this.alpha.abc.charAt(i) + '</a> ';
	}
	
	// Set mouse/keyboard focus
	set("tryit").focus();
}

function puzzleMe(){
	makeRequest(get-puzzle.php,play);
}

function play(xmlData){
if(xmlData){
category=xmlData.getElementsByTagName('category')[0];
words=xmlData.getElementsByTagName('words')[0];
}
}

// This could, in the future, go out and grab a puzzle with an AJAX call
function Game_getPuzzle() {
	var pick=Math.floor(Math.random()*puzzles.length);
	return new Word(puzzles[pick].category,puzzles[pick].word);
}


function Game_checkGuess(ltr) {
	if ( !this.isOver ) {
		var exists = false;
		var occurrences = 0;
		display("message","");
		ltr = ltr.toUpperCase();
		//var ltr = set("tryit").value.toUpperCase();
		set("tryit").value = "";
		if ( ltr >= 'A' && ltr <= 'Z' ) {
			var myGuess = new Guess(ltr);
			if ( this.alpha[myGuess.letter] && this.alpha[myGuess.letter].getGuessed(true) ) {
				display("message","You already guessed " + this.alpha[myGuess.letter].getValue());
			} else {
				this.alpha[myGuess.letter].setGuessed(true);
				for (var i in this.puzzle.letters) {
					if ( this.puzzle.letters[i] == myGuess.letter ) {
						set("w"+i).value = myGuess.letter;
						exists = true;
						occurrences+=1;
					}
				}
				if ( occurrences > 0 ) {
					set(myGuess.letter).className = "letterExists";
					if ( occurrences == 1 ) {
						display("message","There is " + occurrences + " " + ltr + "!");
					} else {
						display("message","There are " + occurrences + " " + ltr + "'s!");
					}
					// Check to see if the user has guessed all letters
					this.checkSolution();
				} else {
					set(myGuess.letter).className = "letterDoesNotExist";
					display("message","Ouch! There are no " + ltr + "'s!");
					this.noose.set(this.noose.get()+1);
					this.noose.display();
					display("message",this.noose.message(ltr));
					if (this.noose.get() >= 6) {
						this.end("Lose");
					}
				}
			}
		}
	}
}

// Check the current guesses agains the solution
function Game_checkSolution() {
	// Set up regular expression to remove punction & spaces -- we compare only the letter portion
	var regex = new RegExp("["+punc+"]","g");
	// String in solution form field
	var s = set("solution").value.toUpperCase();
	// Build string out of all letters on the board--in case the user has guessed all the letters
	var board = "";
	var letters = set("word").getElementsByTagName("input");
	for (var i=0; i<letters.length; i++) {
		board+=letters[i].value;
	}	
	if (s.replace(regex,"")==this.puzzle.word.replace(regex,"") || board.replace(regex,"")==this.puzzle.word.replace(regex,"")) {
		this.end("Win");
	}
}


// End the game
function Game_end(status) {
	// Display message
	display("message",'You '+status+'! <a href="noscript.html" onclick="dgame.init();return false" id="playAgain">Play again</a>');
	// Hide guess letter / guess solution fieldsets
	hide("guess");
	hide("solve");
	// disable letters
	this.puzzle.disable();
	// set game over indicator
	this.isOver = true;
	// Set focus to Play Again link (does this work?)
	set("playAgain").focus;
}

Game.prototype.init = Game_init;
Game.prototype.getPuzzle = Game_getPuzzle;
Game.prototype.checkGuess = Game_checkGuess;
Game.prototype.checkSolution = Game_checkSolution;
Game.prototype.end = Game_end;

/* GAME OBJ:
	isOver property
	word obj
	alphabet/guessing board obj
	gallows/feedback obj
*/


// ------------------
// Shortcut functions
// ------------------

// Sets the value of the element (id) to the specified string (msg)
function display(id,msg) {
	if (set(id)) set(id).innerHTML=msg;
}

// document.getElementById(id) shortcut
function set(id){return document.getElementById(id);}

// display the specified element
function show (id,type){
	//type is an optional parameter. it should be either "block" or "inline"
	if (type === undefined) {
		type = "block";
	}
	document.getElementById(id).style.display = type;
}

// hide the specifed element
function hide (id){
	document.getElementById(id).style.display = "none";
}


</script>
</head>

<body onLoad="dgame=new Game();dgame.init()">
<div id="dump"></div>
<div id="game">
<div id="message"></div>
<div id="gallows"></div>
<div id="triesLeft"></div>
<div id="guessedLetters"></div>

<form onSubmit="dgame.checkGuess();return false">
<fieldset>
<legend id="category"></legend>
<div id="word"></div>
</fieldset>
<fieldset id="guess">
<legend>Guess a Letter</legend>
<input type="text" name="tryit" id="tryit" size="1" maxlength="1" onkeyup="dgame.checkGuess(this.value)"><!--<input type="submit" value="try it">--> 
<!-- <input type="button" value="I know the answer!" onClick="game.checkSolution()"> -->
(You can also click the letters listed above.)
</fieldset>
<fieldset id="solve">
<legend>Solve It!</legend>
<input type="text" name="solution" id="solution" size="50"> <input type="button" value="Solve It!" onClick="dgame.checkSolution()">
</fieldset>
</form>
</div>
<p id="credits">e-mail suggestions to <a href="chris@osric.com">chris@osric.com</a></p>
</body>
</html>
